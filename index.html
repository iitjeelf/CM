<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Examination Platform</title>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===== METTL-LIKE PROFESSIONAL THEME ===== */
:root {
  --primary-color: #2E5BFF;
  --primary-dark: #1A3DB0;
  --secondary-color: #00C9A7;
  --accent-color: #FF6B6B;
  --success-color: #36B37E;
  --warning-color: #FFAB00;
  --danger-color: #FF5630;
  --info-color: #00B8D9;
  
  --light-bg: #F8F9FC;
  --card-bg: #FFFFFF;
  --border-color: #E6E8F0;
  --text-primary: #2E384D;
  --text-secondary: #6B778C;
  --text-light: #B0BAC9;
  
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
  --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
  
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== GLOBAL RESETS ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--light-bg);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== GITHUB DEPLOYMENT WARNING ===== */
.github-warning {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff9800, #ff5722);
  color: white;
  padding: 15px 25px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  z-index: 10001;
  display: none;
  max-width: 90%;
  width: 500px;
  text-align: center;
  animation: slideDown 0.5s ease;
}

.github-warning-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
}

.github-warning-text {
  flex: 1;
  text-align: left;
}

.github-warning-text h4 {
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.github-warning-text p {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 5px;
}

.github-deploy-btn {
  background: white;
  color: #ff5722;
  border: none;
  padding: 8px 15px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.github-deploy-btn:hover {
  background: #f5f5f5;
  transform: translateY(-2px);
}

.github-deploy-btn i {
  margin-right: 5px;
}

/* ===== MICROPHONE TEST MODAL ===== */
.microphone-test-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(10px);
}

.microphone-test-box {
  background: var(--card-bg);
  border-radius: var(--radius-xl);
  width: 90%;
  max-width: 500px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.mic-test-header {
  text-align: center;
  margin-bottom: 25px;
}

.mic-test-header h3 {
  color: var(--primary-color);
  margin-bottom: 8px;
}

.mic-test-visualizer {
  width: 100%;
  height: 120px;
  background: #1a1a2e;
  border-radius: var(--radius-md);
  margin: 20px 0;
  position: relative;
  overflow: hidden;
}

.mic-level-indicator {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(to top, #00C9A7, #36B37E);
  transition: height 0.1s ease;
}

.mic-frequency-canvas {
  width: 100%;
  height: 100%;
}

.mic-test-controls {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}

.mic-test-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#startMicTest {
  background: var(--success-color);
  color: white;
}

#startMicTest:hover:not(:disabled) {
  background: #2a8f66;
  transform: translateY(-2px);
}

#stopMicTest {
  background: var(--danger-color);
  color: white;
}

#stopMicTest:hover:not(:disabled) {
  background: #d9371c;
  transform: translateY(-2px);
}

.mic-test-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.mic-volume-display {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 15px 0;
}

.mic-volume-level {
  color: var(--success-color);
  font-size: 24px;
}

.mic-troubleshooting {
  background: #FFF3CD;
  border: 1px solid #FFEAA7;
  border-radius: var(--radius-md);
  padding: 15px;
  margin: 20px 0;
}

.mic-troubleshooting h4 {
  color: #856404;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mic-troubleshooting ul {
  list-style: none;
  padding-left: 5px;
}

.mic-troubleshooting li {
  margin-bottom: 8px;
  padding-left: 20px;
  position: relative;
}

.mic-troubleshooting li:before {
  content: "‚Ä¢";
  color: #856404;
  position: absolute;
  left: 0;
}

.mic-device-list {
  background: var(--light-bg);
  border-radius: var(--radius-md);
  padding: 15px;
  margin: 15px 0;
  max-height: 200px;
  overflow-y: auto;
}

.device-item {
  padding: 10px;
  border-bottom: 1px solid var(--border-color);
  font-size: 14px;
}

.device-item:last-child {
  border-bottom: none;
}

.device-label {
  font-weight: 600;
  color: var(--text-primary);
}

.device-id {
  font-size: 12px;
  color: var(--text-secondary);
  word-break: break-all;
}

.mic-test-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

#skipMicTest {
  background: var(--text-light);
  color: var(--text-primary);
}

#retryMicTest {
  background: var(--primary-color);
  color: white;
}

/* ===== SYSTEM CHECK SCREEN ===== */
#systemCheckScreen {
  display: none;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  padding: 40px 20px;
}

.system-check-container {
  max-width: 600px;
  margin: 0 auto;
  background: var(--card-bg);
  border-radius: var(--radius-xl);
  padding: 40px;
  box-shadow: var(--shadow-xl);
}

.checklist {
  margin: 32px 0;
}

.check-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  margin-bottom: 12px;
  transition: var(--transition);
}

.check-item:last-child {
  margin-bottom: 0;
}

.check-item.passed {
  border-color: var(--success-color);
  background: rgba(54, 179, 126, 0.05);
}

.check-item.failed {
  border-color: var(--danger-color);
  background: rgba(255, 86, 48, 0.05);
}

.check-item.testing {
  border-color: var(--primary-color);
  background: rgba(46, 91, 255, 0.05);
}

.check-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--light-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
  flex-shrink: 0;
  transition: var(--transition);
}

.check-item.passed .check-icon {
  background: var(--success-color);
  color: white;
}

.check-item.failed .check-icon {
  background: var(--danger-color);
  color: white;
}

.check-item.testing .check-icon {
  background: var(--primary-color);
  color: white;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.check-content {
  flex: 1;
}

.check-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.check-description {
  font-size: 13px;
  color: var(--text-secondary);
}

.check-status {
  font-weight: 600;
  font-size: 14px;
  min-width: 100px;
  text-align: right;
}

.check-item.passed .check-status {
  color: var(--success-color);
}

.check-item.failed .check-status {
  color: var(--danger-color);
}

.check-item.testing .check-status {
  color: var(--primary-color);
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

.toast {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 15px 20px;
  margin-bottom: 10px;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 300px;
  max-width: 400px;
  animation: slideInRight 0.3s ease;
  border-left: 4px solid var(--primary-color);
}

.toast.success {
  border-left-color: var(--success-color);
}

.toast.error {
  border-left-color: var(--danger-color);
}

.toast.warning {
  border-left-color: var(--warning-color);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.toast-icon {
  font-size: 20px;
}

.toast.success .toast-icon {
  color: var(--success-color);
}

.toast.error .toast-icon {
  color: var(--danger-color);
}

.toast.warning .toast-icon {
  color: var(--warning-color);
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.toast-message {
  font-size: 14px;
  color: var(--text-secondary);
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== ACCESS DENIED SCREEN ===== */
.access-denied {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  z-index: 10000;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
  padding: 20px;
}

.access-denied h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.access-code-input {
  padding: 15px 20px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 16px;
  width: 300px;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
  color: var(--text-primary);
}

.verify-btn {
  background: white;
  color: var(--primary-color);
  border: none;
  padding: 15px 40px;
  font-size: 16px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  box-shadow: var(--shadow-md);
}

.verify-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.access-error {
  color: #FFD700;
  margin-top: 15px;
  font-weight: 600;
  display: none;
  background: rgba(255, 0, 0, 0.2);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  animation: shake 0.5s;
}

.github-deployment-info {
  background: rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-top: 30px;
  max-width: 500px;
  text-align: left;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.github-deployment-info h3 {
  color: white;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.github-deployment-info ol {
  margin-left: 20px;
  margin-bottom: 20px;
}

.github-deployment-info li {
  margin-bottom: 10px;
  color: rgba(255, 255, 255, 0.9);
}

.github-deployment-info code {
  background: rgba(0, 0, 0, 0.3);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  color: #FFD700;
}

.github-action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.github-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.github-btn-primary {
  background: white;
  color: #24292e;
}

.github-btn-primary:hover {
  background: #f0f0f0;
  transform: translateY(-2px);
}

.github-btn-secondary {
  background: transparent;
  color: white;
  border: 2px solid white;
}

.github-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition);
  gap: 8px;
  outline: none;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--light-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--border-color);
}

.btn-success {
  background: var(--success-color);
  color: white;
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-full {
  width: 100%;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .system-check-container,
  .microphone-test-box {
    padding: 20px;
  }
  
  .access-code-input {
    width: 100%;
    max-width: 300px;
  }
  
  .mic-test-controls {
    flex-direction: column;
  }
  
  .access-denied h1 {
    font-size: 2em;
  }
  
  .github-deployment-info {
    margin: 20px;
    padding: 15px;
  }
  
  .github-action-buttons {
    flex-direction: column;
  }
  
  .github-warning {
    width: 95%;
    padding: 12px 15px;
  }
  
  .github-warning-content {
    flex-direction: column;
    text-align: center;
  }
  
  .github-warning-text {
    text-align: center;
  }
}
</style>
</head>

<body>

<!-- GitHub Deployment Warning -->
<div id="githubWarning" class="github-warning">
  <div class="github-warning-content">
    <div class="github-warning-text">
      <h4><i class="fas fa-exclamation-triangle"></i> Camera/Microphone Access Required</h4>
      <p>This platform requires camera and microphone access for proctoring.</p>
      <p style="font-size: 12px;">Upload to GitHub Pages to enable these features.</p>
    </div>
    <button id="deployToGitHubBtn" class="github-deploy-btn">
      <i class="fab fa-github"></i> Deploy Now
    </button>
  </div>
</div>

<!-- Microphone Test Modal -->
<div id="microphoneTestModal" class="microphone-test-modal">
  <div class="microphone-test-box">
    <div class="mic-test-header">
      <h3><i class="fas fa-microphone"></i> Microphone Test</h3>
      <p>Please speak to test your microphone</p>
    </div>
    
    <div class="mic-test-visualizer">
      <div id="micLevelIndicator" class="mic-level-indicator"></div>
      <canvas id="micFrequencyCanvas" class="mic-frequency-canvas"></canvas>
    </div>
    
    <div class="mic-volume-display">
      Volume: <span id="micVolumeLevel" class="mic-volume-level">0%</span>
    </div>
    
    <div class="mic-test-controls">
      <button id="startMicTest" class="mic-test-btn">
        <i class="fas fa-play"></i> Start Test
      </button>
      <button id="stopMicTest" class="mic-test-btn" disabled>
        <i class="fas fa-stop"></i> Stop Test
      </button>
    </div>
    
    <div class="mic-troubleshooting">
      <h4><i class="fas fa-tools"></i> Troubleshooting Tips</h4>
      <ul>
        <li>Make sure headphones are properly plugged in</li>
        <li>Check if microphone is muted (look for mute button)</li>
        <li>Speak closer to the microphone</li>
        <li>Ensure browser has microphone permission</li>
        <li>Try unplugging and reconnecting headphones</li>
      </ul>
    </div>
    
    <div id="micDeviceList" class="mic-device-list" style="display:none;">
      <h4>Detected Microphones:</h4>
      <div id="deviceItemsContainer"></div>
    </div>
    
    <div class="mic-test-actions">
      <button id="skipMicTest" class="btn btn-secondary btn-full">
        <i class="fas fa-forward"></i> Skip Test
      </button>
      <button id="retryMicTest" class="btn btn-primary btn-full">
        <i class="fas fa-redo"></i> Retry Detection
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Access Denied Screen -->
<div id="accessDenied" class="access-denied">
    <h1>LFJC ONLINE EXAMINATION</h1>
    <p style="font-size: 1.2em; margin: 10px 0;">TOTAL 75 QUESTIONS</p>
    <p style="margin: 5px 0;">‚Ä¢ Maths: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Physics: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Chemistry: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 10px 0; font-weight: bold;">CORRECT ANSWER + 4 MARKS</p>
    <p style="margin: 5px 0; font-weight: bold;">WRONG ANSWER -1 MARK</p>
    
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code (lfjc2025)">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
    
    <!-- GitHub Deployment Instructions -->
    <div class="github-deployment-info">
      <h3><i class="fab fa-github"></i> Deploy on GitHub Pages</h3>
      <ol>
        <li>Create repository on GitHub</li>
        <li>Upload this file as <code>index.html</code></li>
        <li>Go to Settings ‚Üí Pages ‚Üí Select "main" branch</li>
        <li>Access via: <code>https://username.github.io/repository/</code></li>
      </ol>
      <div class="github-action-buttons">
        <button id="openGitHubBtn" class="github-btn github-btn-primary">
          <i class="fab fa-github"></i> Create GitHub Repository
        </button>
        <button id="learnMoreBtn" class="github-btn github-btn-secondary">
          <i class="fas fa-book"></i> Learn More
        </button>
      </div>
    </div>
</div>

<!-- System Check Screen -->
<div id="systemCheckScreen">
  <div class="system-check-container">
    <div style="text-align: center; margin-bottom: 30px;">
      <h2 style="color: var(--primary-color); margin-bottom: 10px;">
        <i class="fas fa-shield-alt"></i> System Requirements Check
      </h2>
      <p style="color: var(--text-secondary);">Ensuring your system meets all requirements</p>
    </div>
    
    <div class="checklist">
      <div class="check-item" id="browserCheckItem">
        <div class="check-icon">
          <i class="fas fa-globe"></i>
        </div>
        <div class="check-content">
          <div class="check-title">Web Browser Compatibility</div>
          <div class="check-description">Chrome 80+ recommended for best experience</div>
        </div>
        <div class="check-status">Checking...</div>
      </div>
      
      <div class="check-item" id="deploymentCheckItem">
        <div class="check-icon">
          <i class="fab fa-github"></i>
        </div>
        <div class="check-content">
          <div class="check-title">GitHub Pages Deployment</div>
          <div class="check-description">Required for camera/microphone access</div>
        </div>
        <div class="check-status">Checking...</div>
      </div>
      
      <div class="check-item" id="cameraCheckItem">
        <div class="check-icon">
          <i class="fas fa-video"></i>
        </div>
        <div class="check-content">
          <div class="check-title">Camera Access</div>
          <div class="check-description">Required for identity verification</div>
        </div>
        <div class="check-status">Checking...</div>
      </div>
      
      <div class="check-item" id="micCheckItem">
        <div class="check-icon">
          <i class="fas fa-microphone"></i>
        </div>
        <div class="check-content">
          <div class="check-title">Microphone Access</div>
          <div class="check-description">Required for audio monitoring</div>
        </div>
        <div class="check-status">Checking...</div>
      </div>
      
      <div class="check-item" id="networkCheckItem">
        <div class="check-icon">
          <i class="fas fa-wifi"></i>
        </div>
        <div class="check-content">
          <div class="check-title">Network Stability</div>
          <div class="check-description">Minimum 1 Mbps required</div>
        </div>
        <div class="check-status">Checking...</div>
      </div>
    </div>
    
    <div style="display: flex; gap: 15px; margin-top: 30px;">
      <button id="goBackFromCheck" class="btn btn-secondary" style="flex: 1;">
        <i class="fas fa-arrow-left"></i> Back
      </button>
      <button id="proceedToRegistration" class="btn btn-primary" style="flex: 1;" disabled>
        Continue <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </div>
</div>

<script>
// ===== GITHUB DEPLOYMENT FUNCTIONS =====
function checkDeploymentStatus() {
    const isGitHubPages = window.location.hostname.includes('github.io');
    const isHTTPS = window.location.protocol === 'https:';
    const isLocalhost = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
    const isFileProtocol = window.location.protocol === 'file:';
    
    if (isGitHubPages) {
        return { 
            type: 'github-pages',
            passed: true,
            message: 'Deployed on GitHub Pages',
            url: window.location.href
        };
    } else if (isHTTPS && !isGitHubPages) {
        return { 
            type: 'https',
            passed: true,
            message: 'Running on HTTPS',
            url: window.location.href
        };
    } else if (isLocalhost) {
        return { 
            type: 'localhost',
            passed: true,
            message: 'Running on local server',
            url: window.location.href
        };
    } else if (isFileProtocol) {
        return { 
            type: 'file-protocol',
            passed: false,
            message: 'Running locally (file://) - Camera/Mic disabled'
        };
    } else {
        return { 
            type: 'http',
            passed: false,
            message: 'Running on HTTP - Camera/Mic disabled'
        };
    }
}

function showGitHubWarning() {
    const deploymentStatus = checkDeploymentStatus();
    
    if (!deploymentStatus.passed) {
        const warning = document.getElementById('githubWarning');
        warning.style.display = 'block';
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            warning.style.opacity = '0';
            warning.style.transform = 'translate(-50%, -100%)';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 500);
        }, 10000);
    }
}

// ===== HEADPHONE MICROPHONE DETECTOR =====
class HeadphoneMicrophoneDetector {
    constructor() {
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.audioStream = null;
        this.isTesting = false;
        this.devices = [];
        this.dataArray = null;
        this.animationId = null;
        
        // Constants
        this.VOLUME_THRESHOLD = 0.02;
        this.GOOD_VOLUME = 0.05;
        this.GREAT_VOLUME = 0.1;
        this.frequencyBins = 256;
    }
    
    async initialize() {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioContext();
            
            if (this.audioContext.state === 'suspended') {
                await this.audioContext.resume();
            }
            
            return true;
        } catch (error) {
            console.error('Audio context initialization failed:', error);
            return false;
        }
    }
    
    async detectAllAudioDevices() {
        try {
            await this.requestMicrophonePermission();
            
            const allDevices = await navigator.mediaDevices.enumerateDevices();
            this.devices = allDevices.filter(device => 
                device.kind === 'audioinput' && 
                device.deviceId && 
                device.deviceId !== 'default' &&
                !device.deviceId.includes('communications')
            );
            
            console.log('Found audio devices:', this.devices);
            this.displayDevices();
            
            return this.devices;
        } catch (error) {
            console.error('Device enumeration failed:', error);
            this.devices = [];
            return [];
        }
    }
    
    async requestMicrophonePermission() {
        try {
            const constraints1 = {
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    channelCount: 1
                }
            };
            
            const constraints2 = { audio: true };
            
            const constraints3 = {
                audio: {
                    sampleRate: 44100,
                    channelCount: 1,
                    volume: 1.0
                }
            };
            
            let stream = null;
            
            for (const constraints of [constraints1, constraints2, constraints3]) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('Microphone permission granted with constraints:', constraints);
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    return true;
                } catch (error) {
                    console.log('Constraint strategy failed:', constraints, error);
                    continue;
                }
            }
            
            throw new Error('All constraint strategies failed');
            
        } catch (error) {
            console.error('Microphone permission failed:', error);
            return false;
        }
    }
    
    displayDevices() {
        const container = document.getElementById('deviceItemsContainer');
        const deviceList = document.getElementById('micDeviceList');
        
        if (!container || this.devices.length === 0) return;
        
        deviceList.style.display = 'block';
        container.innerHTML = '';
        
        this.devices.forEach((device, index) => {
            const deviceItem = document.createElement('div');
            deviceItem.className = 'device-item';
            
            const isHeadset = this.isLikelyHeadset(device.label || '');
            const headsetIcon = isHeadset ? 'üéß' : 'üé§';
            
            deviceItem.innerHTML = `
                <div class="device-label">
                    ${headsetIcon} ${device.label || `Microphone ${index + 1}`}
                </div>
                <div class="device-id">
                    ${device.deviceId.substring(0, 50)}...
                </div>
            `;
            
            container.appendChild(deviceItem);
        });
    }
    
    isLikelyHeadset(label) {
        if (!label) return false;
        
        const headsetKeywords = [
            'headset', 'headphone', 'earphone', 'headphones', 
            'usb audio', 'bluetooth', 'wireless', 'gaming',
            'logitech', 'hyperx', 'razer', 'steelseries',
            'sony', 'bose', 'jbl', 'sennheiser', 'audio-technica'
        ];
        
        const lowerLabel = label.toLowerCase();
        return headsetKeywords.some(keyword => lowerLabel.includes(keyword));
    }
    
    async startTest(deviceId = null) {
        try {
            this.stopTest();
            
            if (!this.audioContext) {
                await this.initialize();
            }
            
            const constraints = {
                audio: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    channelCount: 1,
                    sampleRate: 44100
                }
            };
            
            this.audioStream = await navigator.mediaDevices.getUserMedia(constraints);
            this.setupAudioAnalysis();
            this.startVisualization();
            
            this.isTesting = true;
            return true;
            
        } catch (error) {
            console.error('Microphone test failed:', error);
            
            try {
                console.log('Trying fallback constraints...');
                this.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.setupAudioAnalysis();
                this.startVisualization();
                this.isTesting = true;
                return true;
            } catch (fallbackError) {
                console.error('Fallback also failed:', fallbackError);
                this.showToast('Failed to access microphone. Please check permissions.', 'error');
                return false;
            }
        }
    }
    
    setupAudioAnalysis() {
        if (!this.audioStream || !this.audioContext) return;
        
        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = this.frequencyBins;
        this.analyser.smoothingTimeConstant = 0.8;
        
        this.microphone = this.audioContext.createMediaStreamSource(this.audioStream);
        this.microphone.connect(this.analyser);
        
        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
    }
    
    startVisualization() {
        const canvas = document.getElementById('micFrequencyCanvas');
        const ctx = canvas.getContext('2d');
        const levelBar = document.getElementById('micLevelIndicator');
        const volumeDisplay = document.getElementById('micVolumeLevel');
        
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        const draw = () => {
            if (!this.isTesting || !this.analyser || !this.dataArray) {
                return;
            }
            
            this.animationId = requestAnimationFrame(draw);
            
            this.analyser.getByteFrequencyData(this.dataArray);
            
            let sum = 0;
            for (let i = 0; i < this.dataArray.length; i++) {
                sum += this.dataArray[i];
            }
            const average = sum / this.dataArray.length;
            const volume = average / 255;
            
            if (volumeDisplay) {
                const percent = Math.round(volume * 100);
                volumeDisplay.textContent = `${percent}%`;
                
                if (volume > this.GREAT_VOLUME) {
                    volumeDisplay.style.color = '#36B37E';
                } else if (volume > this.GOOD_VOLUME) {
                    volumeDisplay.style.color = '#FFAB00';
                } else if (volume > this.VOLUME_THRESHOLD) {
                    volumeDisplay.style.color = '#FF5630';
                } else {
                    volumeDisplay.style.color = '#B0BAC9';
                }
            }
            
            if (levelBar) {
                const heightPercent = Math.min(volume * 300, 100);
                levelBar.style.height = `${heightPercent}%`;
                
                if (volume > this.GREAT_VOLUME) {
                    levelBar.style.background = 'linear-gradient(to top, #36B37E, #00C9A7)';
                } else if (volume > this.GOOD_VOLUME) {
                    levelBar.style.background = 'linear-gradient(to top, #FFAB00, #FFC400)';
                } else if (volume > this.VOLUME_THRESHOLD) {
                    levelBar.style.background = 'linear-gradient(to top, #FF5630, #FF7452)';
                } else {
                    levelBar.style.background = 'linear-gradient(to top, #B0BAC9, #DFE1E6)';
                }
            }
            
            this.drawFrequencyBars(ctx, canvas.width, canvas.height);
        };
        
        draw();
    }
    
    drawFrequencyBars(ctx, width, height) {
        if (!this.dataArray) return;
        
        ctx.clearRect(0, 0, width, height);
        
        const barWidth = (width / this.dataArray.length) * 2.5;
        let x = 0;
        
        for (let i = 0; i < this.dataArray.length; i++) {
            const barHeight = (this.dataArray[i] / 255) * height;
            
            const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
            
            if (barHeight > height * 0.7) {
                gradient.addColorStop(0, '#36B37E');
                gradient.addColorStop(1, '#00C9A7');
            } else if (barHeight > height * 0.4) {
                gradient.addColorStop(0, '#FFAB00');
                gradient.addColorStop(1, '#FFC400');
            } else {
                gradient.addColorStop(0, '#2E5BFF');
                gradient.addColorStop(1, '#8A2BE2');
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, height - barHeight, barWidth, barHeight);
            
            x += barWidth + 1;
        }
    }
    
    stopTest() {
        this.isTesting = false;
        
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
        
        if (this.audioStream) {
            this.audioStream.getTracks().forEach(track => {
                track.stop();
                track.enabled = false;
            });
            this.audioStream = null;
        }
        
        if (this.microphone) {
            this.microphone.disconnect();
            this.microphone = null;
        }
        
        if (this.analyser) {
            this.analyser.disconnect();
            this.analyser = null;
        }
        
        const canvas = document.getElementById('micFrequencyCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        const levelBar = document.getElementById('micLevelIndicator');
        if (levelBar) {
            levelBar.style.height = '0%';
        }
        
        const volumeDisplay = document.getElementById('micVolumeLevel');
        if (volumeDisplay) {
            volumeDisplay.textContent = '0%';
            volumeDisplay.style.color = '#B0BAC9';
        }
    }
    
    async testAllDevices() {
        const devices = await this.detectAllAudioDevices();
        
        if (devices.length === 0) {
            return { success: false, message: 'No microphones detected' };
        }
        
        for (const device of devices) {
            console.log(`Testing device: ${device.label || device.deviceId}`);
            
            const success = await this.startTest(device.deviceId);
            
            if (success) {
                const hasAudio = await this.checkForAudio(2000);
                
                if (hasAudio) {
                    this.showToast(`‚úì Microphone working: ${device.label || 'Device'}`, 'success');
                    return { 
                        success: true, 
                        device: device,
                        isHeadset: this.isLikelyHeadset(device.label || '')
                    };
                }
            }
            
            this.stopTest();
        }
        
        return { success: false, message: 'No working microphone found' };
    }
    
    async checkForAudio(duration = 2000) {
        return new Promise((resolve) => {
            if (!this.analyser || !this.dataArray) {
                resolve(false);
                return;
            }
            
            let maxVolume = 0;
            const startTime = Date.now();
            
            const checkInterval = setInterval(() => {
                if (!this.isTesting) {
                    clearInterval(checkInterval);
                    resolve(false);
                    return;
                }
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                let sum = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    sum += this.dataArray[i];
                }
                const volume = sum / this.dataArray.length / 255;
                
                maxVolume = Math.max(maxVolume, volume);
                
                if (Date.now() - startTime > duration) {
                    clearInterval(checkInterval);
                    console.log(`Max volume detected: ${maxVolume.toFixed(3)}`);
                    resolve(maxVolume > this.VOLUME_THRESHOLD);
                }
            }, 50);
        });
    }
    
    cleanup() {
        this.stopTest();
        
        if (this.audioContext) {
            this.audioContext.close();
            this.audioContext = null;
        }
    }
    
    showToast(message, type = 'info') {
        showToast(message, type);
    }
}

// ===== TOAST SYSTEM =====
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">&times;</button>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
    
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
}

// ===== SYSTEM CHECK FUNCTIONS =====
let microphoneDetector = null;

async function runSystemChecks() {
    console.log('Running system checks...');
    
    const checks = [
        { id: 'browserCheckItem', test: checkBrowserCompatibility },
        { id: 'deploymentCheckItem', test: checkDeployment },
        { id: 'cameraCheckItem', test: checkCameraAccess },
        { id: 'micCheckItem', test: checkMicrophoneAccess },
        { id: 'networkCheckItem', test: checkNetworkStability }
    ];
    
    let allPassed = true;
    
    for (let i = 0; i < checks.length; i++) {
        const check = checks[i];
        const element = document.getElementById(check.id);
        const status = element.querySelector('.check-status');
        
        element.classList.remove('passed', 'failed');
        element.classList.add('testing');
        status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        
        try {
            const result = await check.test();
            
            if (result.passed) {
                element.classList.remove('testing');
                element.classList.add('passed');
                status.innerHTML = '<i class="fas fa-check-circle"></i> Passed';
                
                if (result.message) {
                    element.querySelector('.check-description').textContent = result.message;
                }
            } else {
                element.classList.remove('testing');
                element.classList.add('failed');
                status.innerHTML = '<i class="fas fa-times-circle"></i> Failed';
                allPassed = false;
                
                if (result.message) {
                    element.querySelector('.check-description').textContent = result.message;
                }
                
                if (check.id === 'micCheckItem' && result.canTest) {
                    setTimeout(() => showMicrophoneTestModal(), 1000);
                }
            }
        } catch (error) {
            console.error(`Check ${check.id} failed:`, error);
            element.classList.remove('testing');
            element.classList.add('failed');
            status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            allPassed = false;
        }
        
        if (i < checks.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 800));
        }
    }
    
    document.getElementById('proceedToRegistration').disabled = !allPassed;
    
    return allPassed;
}

async function checkBrowserCompatibility() {
    const isChrome = /chrome|chromium|crios/i.test(navigator.userAgent);
    const versionMatch = navigator.userAgent.match(/(chrome|chromium|crios)\/(\d+)/i);
    const version = versionMatch ? parseInt(versionMatch[2]) : 0;
    
    return {
        passed: isChrome && version >= 80,
        message: isChrome ? `Chrome ${version}` : 'Use Chrome 80+'
    };
}

async function checkDeployment() {
    const deploymentStatus = checkDeploymentStatus();
    
    return {
        passed: deploymentStatus.passed,
        message: deploymentStatus.message
    };
}

async function checkCameraAccess() {
    try {
        const deploymentStatus = checkDeploymentStatus();
        
        if (!deploymentStatus.passed) {
            return { 
                passed: false, 
                message: 'Deploy to GitHub Pages for camera access' 
            };
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return { passed: false, message: 'Camera API not supported' };
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        
        return { passed: true, message: 'Camera accessible' };
    } catch (error) {
        console.error('Camera check failed:', error);
        return { 
            passed: false, 
            message: 'Camera access denied or not available' 
        };
    }
}

async function checkMicrophoneAccess() {
    try {
        const deploymentStatus = checkDeploymentStatus();
        
        if (!deploymentStatus.passed) {
            return { 
                passed: false, 
                canTest: false,
                message: 'Deploy to GitHub Pages for microphone access'
            };
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return { passed: false, message: 'Microphone API not supported' };
        }
        
        microphoneDetector = new HeadphoneMicrophoneDetector();
        
        const hasPermission = await microphoneDetector.requestMicrophonePermission();
        if (!hasPermission) {
            return { 
                passed: false, 
                canTest: true,
                message: 'Permission not granted. Click to test.' 
            };
        }
        
        const devices = await microphoneDetector.detectAllAudioDevices();
        if (devices.length === 0) {
            return { 
                passed: false, 
                canTest: true,
                message: 'No microphone detected. Click to test.' 
            };
        }
        
        const testResult = await microphoneDetector.testAllDevices();
        
        if (testResult.success) {
            microphoneDetector.cleanup();
            const deviceType = testResult.isHeadset ? 'Headset' : 'Microphone';
            return { 
                passed: true, 
                message: `${deviceType} detected: ${testResult.device.label || 'Device'}` 
            };
        } else {
            return { 
                passed: false, 
                canTest: true,
                message: 'Microphone not working. Click to test.' 
            };
        }
        
    } catch (error) {
        console.error('Microphone check failed:', error);
        return { 
            passed: false, 
            canTest: false,
            message: 'Microphone check failed' 
        };
    }
}

async function checkNetworkStability() {
    if (!navigator.onLine) {
        return { passed: false, message: 'No internet connection' };
    }
    
    if (navigator.connection) {
        const connection = navigator.connection;
        const downlink = connection.downlink || 0;
        const effectiveType = connection.effectiveType || 'unknown';
        
        return {
            passed: downlink >= 1,
            message: `Speed: ${downlink.toFixed(1)} Mbps (${effectiveType})`
        };
    }
    
    return { passed: true, message: 'Network connected' };
}

// ===== MICROPHONE TEST MODAL FUNCTIONS =====
function showMicrophoneTestModal() {
    const modal = document.getElementById('microphoneTestModal');
    modal.style.display = 'flex';
    
    if (!microphoneDetector) {
        microphoneDetector = new HeadphoneMicrophoneDetector();
    }
    
    setupMicrophoneTestModal();
}

function setupMicrophoneTestModal() {
    const modal = document.getElementById('microphoneTestModal');
    
    document.getElementById('startMicTest').onclick = async () => {
        try {
            document.getElementById('startMicTest').disabled = true;
            document.getElementById('stopMicTest').disabled = false;
            
            const result = await microphoneDetector.testAllDevices();
            
            if (!result.success) {
                showToast('No working microphone found. Please check connections.', 'error');
                document.getElementById('startMicTest').disabled = false;
                document.getElementById('stopMicTest').disabled = true;
            } else {
                showToast('Microphone test started. Speak into your microphone.', 'info');
            }
            
        } catch (error) {
            console.error('Failed to start microphone test:', error);
            showToast('Failed to start test: ' + error.message, 'error');
            document.getElementById('startMicTest').disabled = false;
            document.getElementById('stopMicTest').disabled = true;
        }
    };
    
    document.getElementById('stopMicTest').onclick = () => {
        microphoneDetector.stopTest();
        document.getElementById('stopMicTest').disabled = true;
        document.getElementById('startMicTest').disabled = false;
        showToast('Microphone test stopped', 'info');
    };
    
    document.getElementById('skipMicTest').onclick = () => {
        if (microphoneDetector) {
            microphoneDetector.cleanup();
        }
        
        modal.style.display = 'none';
        
        const micItem = document.getElementById('micCheckItem');
        const status = micItem.querySelector('.check-status');
        
        micItem.classList.remove('failed', 'testing');
        micItem.classList.add('failed');
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Skipped';
        
        showToast('Microphone test skipped. Audio monitoring disabled.', 'warning');
    };
    
    document.getElementById('retryMicTest').onclick = async () => {
        if (microphoneDetector) {
            microphoneDetector.cleanup();
        }
        
        const result = await checkMicrophoneAccess();
        
        if (result.passed) {
            const micItem = document.getElementById('micCheckItem');
            const status = micItem.querySelector('.check-status');
            
            micItem.classList.remove('failed', 'testing');
            micItem.classList.add('passed');
            status.innerHTML = '<i class="fas fa-check-circle"></i> Passed';
            
            modal.style.display = 'none';
            showToast('Microphone detected successfully!', 'success');
            
            checkAllPassed();
        } else {
            showToast('Still no microphone detected. Click "Skip Test" to proceed.', 'error');
        }
    };
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

function checkAllPassed() {
    const allChecks = document.querySelectorAll('.check-item');
    let allPassed = true;
    
    allChecks.forEach(check => {
        if (!check.classList.contains('passed')) {
            allPassed = false;
        }
    });
    
    document.getElementById('proceedToRegistration').disabled = !allPassed;
    return allPassed;
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const accessCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const ACCESS_CODE = "lfjc2025";
    
    errorElement.style.display = 'none';
    
    if (accessCode === ACCESS_CODE) {
        document.getElementById('accessDenied').style.display = 'none';
        document.getElementById('systemCheckScreen').style.display = 'block';
        
        setTimeout(() => runSystemChecks(), 500);
        
        showToast('Access granted! Running system checks...', 'success');
    } else {
        errorElement.style.display = 'block';
        
        const accessDenied = document.getElementById('accessDenied');
        accessDenied.style.animation = 'none';
        setTimeout(() => {
            accessDenied.style.animation = 'shake 0.5s';
        }, 10);
        
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
    }
}

// ===== GITHUB BUTTONS =====
document.getElementById('deployToGitHubBtn')?.addEventListener('click', () => {
    window.open('https://github.com/new', '_blank');
});

document.getElementById('openGitHubBtn')?.addEventListener('click', () => {
    window.open('https://github.com/new', '_blank');
});

document.getElementById('learnMoreBtn')?.addEventListener('click', () => {
    window.open('https://pages.github.com', '_blank');
});

// ===== INITIALIZATION =====
window.addEventListener('load', function() {
    console.log('LFJC Examination Platform Loaded');
    
    // Check deployment status
    const deploymentStatus = checkDeploymentStatus();
    console.log('Deployment status:', deploymentStatus);
    
    // Show warning if not properly deployed
    if (!deploymentStatus.passed) {
        showGitHubWarning();
    }
    
    // Show access screen
    document.getElementById('accessDenied').style.display = 'flex';
    document.getElementById('systemCheckScreen').style.display = 'none';
    
    // Focus on access code
    document.getElementById('accessCode').focus();
    
    // Setup event listeners
    document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
    
    document.getElementById('accessCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyAccessCode();
        }
    });
    
    document.getElementById('goBackFromCheck').addEventListener('click', function() {
        document.getElementById('systemCheckScreen').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'flex';
        document.getElementById('accessCode').focus();
    });
    
    document.getElementById('proceedToRegistration').addEventListener('click', function() {
        showToast('Proceeding to registration...', 'success');
        // Add your registration logic here
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (microphoneDetector) {
            microphoneDetector.cleanup();
        }
    });
});
</script>
</body>
</html>
